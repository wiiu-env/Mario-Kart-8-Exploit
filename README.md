# Mario-Kart-8-Exploit

While connecting to another console, games may send an application-specific [identification token](https://github.com/Kinnay/NintendoClients/wiki/PIA-Types#identificationinfo). In Mario Kart 8, this token consists of three numbers separated by underscores (for example: 0_44806416_1). When the host of a P2P session receives a [JoinRequest](https://github.com/Kinnay/NintendoClients/wiki/Mesh-Protocol#join-request), a "joining mesh approval callback" is called. In Mario Kart 8, this method tries to parse and verify the identification token. To extract the numbers from the token, it copies the token into a string on the stack until it sees an underscore, converts it to an integer, copies the next part until it sees an underscore, and so on. However, this string can only hold up to 16 bytes, while an identification token may consist of up to 32 bytes. If you send a token that contains more than 16 bytes you can overwrite up to 16 bytes of stack memory, as long as your token does not contain an underscore or null byte.

One of the things that can be overwritten is the vtable pointer of another string on the stack. Immediately after one part of the token has been converted to an integer, a virtual method called assureTerminationImpl (which ensures that the string is terminated with a null byte) is called on this string. By building your own vtable on the stack you can redirect code execution (almost) anywhere you want. For example, the following token causes OSFatal to be called as soon as the console tries to parse it: `\x01\x03\x16\x18aaaaaaaaaaaa\x38\x60\x43\xd8\x38\x60\x42\xD0`

If you choose the right target you can write an arbitrary value at an arbitrary address, and by disconnecting and reconnecting with a different identification token this bug can be exploited repeatedly.

If you want to see this in action, try to run [exploit.py](https://github.com/Kinnay/Mario-Kart-8-Exploit/blob/master/exploit.py):
1. Fill in the required information, like your device id and serial number. FRIEND_NAME should be the NNID of the user whose console you want to hack.
2. You will need this python package to run exploit.py: https://github.com/Kinnay/NintendoClients
3. Create a friend room in Mario Kart 8 and run exploit.py. If everything went right, it should call OSFatal with a nice little message.

Currently, exploit.py only works if there are no other players in the friend room, but with some work this exploit can be adapted to work anywhere.
